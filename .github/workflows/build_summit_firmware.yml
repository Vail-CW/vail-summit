name: Build and Deploy Summit Firmware

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Branch to build firmware from'
        required: true
        default: 'main'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing to repository

    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
          fetch-depth: 0  # Fetch all history for all branches

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@2.0.14

      - name: Install required libraries
        run: |
          # Display and UI libraries
          arduino-cli lib install "LovyanGFX"
          # IMPORTANT: Must use LVGL 8.3.x - code is not compatible with LVGL 9.x
          arduino-cli lib install "lvgl@8.3.11"

          # Battery monitoring
          arduino-cli lib install "Adafruit MAX1704X"
          arduino-cli lib install "Adafruit LC709203F"

          # Network libraries
          arduino-cli lib install "WebSockets"
          arduino-cli lib install "ArduinoJson"

          # Bluetooth library (for BLE HID/MIDI)
          arduino-cli lib install "NimBLE-Arduino"

          # Install ESPAsyncWebServer and AsyncTCP from GitHub (not in Library Manager)
          mkdir -p ~/Arduino/libraries
          cd ~/Arduino/libraries

          # Install AsyncTCP (dependency for ESPAsyncWebServer on ESP32)
          git clone https://github.com/me-no-dev/AsyncTCP.git

          # Install ESPAsyncWebServer
          git clone https://github.com/me-no-dev/ESPAsyncWebServer.git

      - name: Configure LVGL
        run: |
          # LVGL requires lv_conf.h to be in the libraries folder (next to lvgl folder)
          # Copy our project's lv_conf.h to the Arduino libraries folder
          cp lv_conf.h ~/Arduino/libraries/lv_conf.h

          echo "LVGL configuration:"
          head -50 ~/Arduino/libraries/lv_conf.h

      - name: Show board options
        run: |
          echo "Available board options for adafruit_feather_esp32s3:"
          arduino-cli board details -b esp32:esp32:adafruit_feather_esp32s3

      - name: Build firmware
        run: |
          # The .ino file is in the root directory on vail-summit branch
          # Arduino CLI requires the sketch to be in a folder with matching name
          mkdir -p vail-summit
          cp vail-summit.ino vail-summit/
          cp -r src vail-summit/

          # Build for ESP32-S3 Feather with 4-inch display configuration
          # FQBN options:
          # - CDCOnBoot=cdc: Enable USB CDC for serial output
          # - PartitionScheme=huge_app: 3MB app, no OTA, 1MB SPIFFS
          # - PSRAM=enabled: Enable PSRAM (hardware auto-detects OPI vs QSPI)
          # - FlashSize=4M: 4MB flash
          arduino-cli compile \
            --fqbn "esp32:esp32:adafruit_feather_esp32s3:CDCOnBoot=cdc,PartitionScheme=huge_app,PSRAM=enabled,FlashSize=4M" \
            --output-dir build \
            --export-binaries \
            vail-summit/vail-summit.ino

          # List generated files
          echo "Generated files:"
          ls -lh build/

      - name: Rename binary files
        run: |
          cd build
          # Rename files to standard names
          mv vail-summit.ino.bootloader.bin bootloader.bin || true
          mv vail-summit.ino.partitions.bin partitions.bin || true
          mv vail-summit.ino.bin vail-summit.bin || true

          echo "Renamed files:"
          ls -lh

      - name: Copy binaries to firmware directory
        run: |
          mkdir -p docs/firmware_files/summit
          cp build/bootloader.bin docs/firmware_files/summit/
          cp build/partitions.bin docs/firmware_files/summit/
          cp build/vail-summit.bin docs/firmware_files/summit/

          echo "Files copied to docs/firmware_files/summit/:"
          ls -lh docs/firmware_files/summit/

      - name: Commit and push firmware
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add docs/firmware_files/summit/*.bin

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Summit firmware from ${{ inputs.source_branch }} branch [skip ci]

            Built from branch: ${{ inputs.source_branch }}
            Commit: ${{ github.sha }}

            Firmware files:
            - bootloader.bin
            - partitions.bin
            - vail-summit.bin

            ðŸ¤– Generated with GitHub Actions"

            # Push using the GitHub token for authentication
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git ${{ inputs.source_branch }}
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: summit-firmware-${{ github.sha }}
          path: |
            build/bootloader.bin
            build/partitions.bin
            build/vail-summit.bin
          retention-days: 30
