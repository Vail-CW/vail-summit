name: Build and Deploy Summit Firmware

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.50, v1.0, etc.
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Branch to build firmware from'
        required: true
        default: 'main'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing to repository

    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'push' && github.ref || inputs.source_branch }}
          fetch-depth: 0  # Fetch all history for all branches

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@2.0.14

      - name: Install required libraries
        run: |
          # Display and UI libraries
          arduino-cli lib install "LovyanGFX"
          # IMPORTANT: Must use LVGL 8.3.x - code is not compatible with LVGL 9.x
          arduino-cli lib install "lvgl@8.3.11"

          # Battery monitoring
          arduino-cli lib install "Adafruit MAX1704X"
          arduino-cli lib install "Adafruit LC709203F"

          # Network libraries
          arduino-cli lib install "ArduinoJson"

          # Bluetooth library (for BLE HID/MIDI)
          # IMPORTANT: Must use NimBLE-Arduino 1.4.x - code is not compatible with 2.x API
          arduino-cli lib install "NimBLE-Arduino@1.4.2"

          # Install libraries from GitHub (not in Library Manager or have version issues)
          mkdir -p ~/Arduino/libraries
          cd ~/Arduino/libraries

          # WebSockets - clone specific version (library manager has ESP32 detection issues)
          git clone --branch 2.4.1 --depth 1 https://github.com/Links2004/arduinoWebSockets.git WebSockets

          # AsyncTCP and ESPAsyncWebServer from me-no-dev (now maintained by ESP32Async, has MD5Builder.h fix)
          git clone --depth 1 https://github.com/me-no-dev/AsyncTCP.git
          git clone --depth 1 https://github.com/me-no-dev/ESPAsyncWebServer.git

      - name: Configure LVGL
        run: |
          # LVGL requires lv_conf.h to be in the libraries folder (next to lvgl folder)
          # Copy our project's lv_conf.h to the Arduino libraries folder
          cp lv_conf.h ~/Arduino/libraries/lv_conf.h

          echo "LVGL configuration:"
          head -50 ~/Arduino/libraries/lv_conf.h

      - name: Show board options
        run: |
          echo "Available board options for adafruit_feather_esp32s3:"
          arduino-cli board details -b esp32:esp32:adafruit_feather_esp32s3

      - name: Build firmware
        env:
          FIREBASE_MAILBOX_API_KEY: ${{ secrets.FIREBASE_MAILBOX_API_KEY }}
          FIREBASE_CWSCHOOL_API_KEY: ${{ secrets.FIREBASE_CWSCHOOL_API_KEY }}
        run: |
          # The .ino file is in the root directory on vail-summit branch
          # Arduino CLI requires the sketch to be in a folder with matching name
          mkdir -p vail-summit
          cp vail-summit.ino vail-summit/
          cp -r src vail-summit/

          # Build extra flags - include ESP32 define and WebSockets network type fix
          # ESP32 must be explicitly defined when using build.extra_flags (it overwrites defaults)
          # WEBSOCKETS_NETWORK_TYPE=4 forces ESP32 mode (avoids Ethernet.h dependency)
          EXTRA_FLAGS="-DESP32 -DWEBSOCKETS_NETWORK_TYPE=4"
          if [ -n "$FIREBASE_MAILBOX_API_KEY" ]; then
            EXTRA_FLAGS="$EXTRA_FLAGS -DFIREBASE_MAILBOX_API_KEY=\"$FIREBASE_MAILBOX_API_KEY\""
          fi
          if [ -n "$FIREBASE_CWSCHOOL_API_KEY" ]; then
            EXTRA_FLAGS="$EXTRA_FLAGS -DFIREBASE_CWSCHOOL_API_KEY=\"$FIREBASE_CWSCHOOL_API_KEY\""
          fi

          # Build for ESP32-S3 Feather with 4-inch display configuration
          # FQBN options:
          # - CDCOnBoot=cdc: Enable USB CDC for serial output
          # - PartitionScheme=huge_app: 3MB app, no OTA, 1MB SPIFFS
          # - PSRAM=enabled: Enable PSRAM (hardware auto-detects OPI vs QSPI)
          # - FlashSize=4M: 4MB flash
          # - USBMode=hwcdc: Use hardware CDC (shows as "USB JTAG/Serial" not "TinyUSB CDC")
          #   This enables 1200-baud auto-reset for web flasher compatibility
          arduino-cli compile \
            --fqbn "esp32:esp32:adafruit_feather_esp32s3:CDCOnBoot=cdc,PartitionScheme=huge_app,PSRAM=enabled,FlashSize=4M,USBMode=hwcdc" \
            --build-property "build.extra_flags=$EXTRA_FLAGS" \
            --output-dir build \
            --export-binaries \
            vail-summit/vail-summit.ino

          # List generated files
          echo "Generated files:"
          ls -lh build/

      - name: Rename binary files
        run: |
          cd build
          # Rename files to standard names
          mv vail-summit.ino.bootloader.bin bootloader.bin || true
          mv vail-summit.ino.partitions.bin partitions.bin || true
          mv vail-summit.ino.bin vail-summit.bin || true

          echo "Renamed files:"
          ls -lh

      - name: Copy binaries to firmware directory
        run: |
          mkdir -p firmware_files
          cp build/bootloader.bin firmware_files/
          cp build/partitions.bin firmware_files/
          cp build/vail-summit.bin firmware_files/

          echo "Files copied to firmware_files/:"
          ls -lh firmware_files/

      - name: Commit and push firmware
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add firmware_files/*.bin

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Summit firmware from ${{ github.ref_name }} [skip ci]

            Built from: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            Firmware files:
            - bootloader.bin
            - partitions.bin
            - vail-summit.bin

            ðŸ¤– Generated with GitHub Actions"

            # Push using the GitHub token for authentication
            # For tag pushes, push to main; for workflow_dispatch, push to the specified branch
            TARGET_BRANCH="${{ github.event_name == 'push' && 'main' || inputs.source_branch }}"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:$TARGET_BRANCH
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: summit-firmware-${{ github.sha }}
          path: |
            build/bootloader.bin
            build/partitions.bin
            build/vail-summit.bin
          retention-days: 30
